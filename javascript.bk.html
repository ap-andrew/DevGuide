<p>[toc]</p>
<p>This topic covers examples that illustrate simple JavaScript that can be executed on the API Platform to customize the behavior of an API.</p>

<p>You can combine JavaScript with out-of-the-box policies in API proxy to implement custom behavior. JavaScript is usually used to interact with message content and to implement a level of application logic on top of the standard configurations and policies provided by the API Platform.</p>

<div class="samplegithub"><p>JavaScript samples are available in the <a href="https://github.com/apigee/api-platform-samples/tree/master/simpleProxy/apiproxy/resources/jsc">API Platform Samples</a> repository on GitHub.</p></div>

<p>The samples demonstrate simple interactions with message content, as well dynamic target routing, asynchronous callouts. (More advanced samples that demonstrate how to build composite services and how to manage outbound OAuth tokens are covered in the next topics.)</p>

<p>It can be useful to examine the samples and to deploy and invoke to get a sense of how JavaScript fits into an API proxy Flow. At the most basic level you will find that a JavaScript file is referenced by a policy of type Javascript.</p>

<p>For example, the following policy references a JavaScript file called <code>changeResponse.js.</code></p>

<pre>&lt;Javascript name='changeResponse' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://changeResponse.js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>

<div class="bestpractice">Always use the extension <code>.js</code> for JavaScript resources.</div>

<p>You can attach this Policy to an API proxy Flow just like any other Policy type. By attaching the Policy to the API proxy Flow, you indicate where the JavaScript should be executed. You can execute JavaScript in the ProxyEndpoint request Flow to parse request messages, for example. You can also execute JavaScript in the TargetEndpoint request Flow to execute some logic to determine the backend URL to use.</p>

<div class="warning">The Policy type must be capitalized appropriately in the Policy definition. Although "JavaScript" is the accepted spelling of the name of the programming language, in the Policy it must be capitalized as "Javascript".</div>

<h2>When to use JavaScript</h2>

<p>Use out-of-the-box policies where possible, and avoid the temptation to code all of your proxy logic in JavaScript. Even though the API Platform leverages compiled JavaScript to improve performance, JavaScript will be unlikely to perform as well as Policies. JavaScript may be more difficult to maintain and debug. Reserve JavaScript for functionality that is unique to your requirements. </p>

<p>If performance is a concern for custom functionality, use Java where possible.</p>

<p>The procedure to execute JavaScript in an API proxy is as follows:</p>
<ol>
	<li>Write JavaScript to the [node:3976]</li>
	<li>Create a JavaScript resource under <code>/resources/jsc</code></span>&nbsp;in your <code>/apiproxy</code></li>
	<li>Create a matching policy of type 'Javascript' in <code>/apiproxy/policies</code></li>
	<li>Attach the policy at the appropriate point in the processing flow</li>
	<li>Upload, deploy, test and trace API calls in the Management UI to debug your JavaScript</li>
</ol>

<h2>Modifying a response message using JavaScript</h2>

<h3>Creating a JavaScript resource</h3>

<p>This example demonstrates a simple JavaScript app that changes a response message by modifying the HTTP headers and payload of a response generated by the backend service. This JavaScript uses [node:243], which the API Platform makes available as part of standard Flow processing. The variables used here are response message variables: <code>response.status</code>, <code>response.headers</code>, and <code>response.content</code>.</p>

<p>First let's look at the code for <code>changeResponse.js</code></p>
	
<pre>context.proxyResponse.status ="200";
context.proxyResponse.headers['X-Apigee-Test-Header-1'][0]='target.name';
context.proxyResponse.headers['X-Apigee-Test-Header-2'][0]='Test-Header 2 Value 0';
context.proxyResponse.headers['X-Apigee-Test-Header-2'][1]='Test-Header 2 Value 1';
context.proxyResponse.content='This is your code on Apigee!';</pre>

<p>This JavaScript performs three actions:

<ul><li>Sets the HTTP status code of the response to 200.</li>
<li>Creates 3 HTTP headers. The value of the  first HTTP header, <code>X-Apigee-Test-Header-1</code> is dynamic; it will be set based on the value of the variable that it references: <code>target.name</code>. The other two are static.</li>
<li>Generates static payload content</li>
</ul>

<p>You can see that the base JavaScript object is a <code>context</code>. The context in turn exposes objects the represent messages at each processing stage. In this case, the JavaScript interacts with the <code>proxyResponse</code>, that is, the response message generated by the ProxyEndpoint. The <code>proxyResponse</code> in turn has number of associated objects, In this case, the JavaScript interacts with <code>status</code>, <code>headers</code>, and <code>content</code>. (All of these objects are described in [node:3976].)</p>

<div class="tipstricks">A useful exercise once you have the JavaScript working is to modify these fields to use other values. For example, you can try changing the variable that sets the HTTP header by selecting a different variable from the list of [node:243].</div>

<h2>Storing JavaScript as a resource</h2>

<p>JavaScript (like other resources such as Python scripts, Java JAR files, and XSLT files) can be stored in the API proxy, in the environment, and in the organization. Once you have the file called <code>changeResponse.js</code>, store it under<code>/apiproxy/resources/jsc</code>.</p>

<div class="bestpractices">When you are just starting to work with JavaScript it is easiest to store it in the API proxy. As you advance, JavaScript should be made as generic and reusable as possible, and then stored at the environment or organization level. This prevents JavaScript from being copied across multiple API proxies, and therefore becoming unmanageable. See [node:11972].</div>

<h3>Creating a JavaScript policy</h3>

<p>JavaScript resources are executed by policies of type Javascript. The Policy rellay just provides a reference to the file containing the JavaScript. A Javascript policy references a JavaScript resource by name as <code>ResourceURL</code>. For example, to create a policy that references a JavaScript resources named <code>changeResponse.js</code>, the following policy would be created under<code>/apiproxy/policies</code>:</p>

<pre>&lt;Javascript name='changeResponse' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://changeResponse.js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>

<div class="warning"><p>The maximum time limit permitted for JavaScript policies to execute in environments in free trial organization is 200 milliseconds.</p></div>

<h3>Attaching JavaScript policies to an API proxy Flow</h3>

<p>The following configuration demonstrates the attachment of a Javascript policy to a ProxyEndpoint response Flow. The Policy is attached to the response Flow because the JavaScript that it references modifies the response message before it is sent to the requesting client app:</p>

<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PostFlow&gt;
  &lt;Response&gt;
    &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
  &lt;/Response&gt;
  &lt;/PostFlow&gt;
  &lt;HTTPProxyConnection&gt;
    &lt;BasePath&gt;/weather&lt;/BasePath&gt;
    &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
  &lt;/HTTPProxyConnection&gt;
  &lt;RouteRule name="default"&gt;
    &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
  &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>

<h3>Importing and deploying the API proxy</h3>

<p>The deploy tool can be used to deploy the API proxy by substituting valid values for username, password, and organization.</p>

	<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o {org_name} -e test -p / -d simpleProxy</pre>

		<pre>Writing simpleProxy/apiproxy/weatherapi.xml to apiproxy/weatherapi.xml
Writing simpleProxy/apiproxy/policies/ChangeResponse.xml to apiproxy/policies/ChangeResponse.xml
Writing simpleProxy/apiproxy/proxies/default.xml to apiproxy/proxies/default.xml
Writing simpleProxy/apiproxy/resources/jsc/changeResponse.jsc to apiproxy/resources/jsc/changeResponse.jsc
Writing simpleProxy/apiproxy/targets/default.xml to apiproxy/targets/default.xml
Imported new proxy version 1
Environment: test
&nbsp; Revision: 1 BasePath = /
&nbsp; State: deployed
&nbsp;</pre>

<h3>Testing JavaScript</h3>

<p>The curl flag <code>-v</code> can be used to view HTTP headers on the response message modified by the JavaScript.</p>

<p>Submit a request as follows:</p>

<pre>$ curl -v http://{org_name}-test.apigee.net/weather </pre>

<p>If the JavaScript executes properly, you will get the following response:</p>

		<pre>&lt; X-Apigee-Test-Header-1: Test-Header 1 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 1
&lt; Content-Length: 27

This is your code on Apigee!</pre>

<p>You can now modify the JavaScript to try new things, redeploy the API proxy, and verify the results by submitting the same request.</p>

<h2>Generating a JSON Response</h2>

<p>In this example, you work with JavaScript that generates a response message.</p>

<p>The following JavaScript sample generates a static JSON response to a request.</p>

<h3>Creating the JavaScript resource</h3>

<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse.js</code> under <code>/apiproxy/resources/jsc</code> with the following contents:</p>

<pre>context.proxyResponse.content=''; 
context.proxyResponse.headers['Content-Type']='application/json'; 
var json = context.proxyResponse.content.asJSON;

json.country = 'us';
json.postalcode = '95123'
json.elevation = 'Very High';</pre>



<h3>Creating a policy that references the JavaScript resource</h3>

<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse.xml</code> under <code>/apiproxy/policies</code> with the following contents:</p>

<pre>&lt;Javascript name='generateResponse' timeLimit='200'&gt;
&nbsp;&nbsp;&nbsp; &lt;ResourceURL&gt;jsc://generateResponse.js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>

<h3>Attaching the JavaScript policy to the ProxyEndpoint response PostFlow</h3>

<p>To execute this policy, the ProxyEndpoint, <code>/apiproxy/proxies/default.xml</code>, should be configured as follows:</p>

			<pre>&lt;ProxyEndpoint name="default"&gt;
  &lt;PostFlow&gt;
    &lt;Response&gt;
      &lt;Step&gt;
        &lt;Name&gt;generateResponse&lt;/Name&gt;
      &lt;/Step&gt;
    &lt;/Response&gt;
  &lt;/PostFlow&gt;
  &lt;HTTPProxyConnection&gt;
    &lt;BasePath&gt;/weather&lt;/BasePath&gt;
    &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
  &lt;/HTTPProxyConnection&gt;
  &lt;RouteRule name="default"&gt;
     &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
  &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>

<h3>Testing the JavaScript</h3>

<pre>$ curl http://{org_name}-test.apigee.net/weather</pre>

<pre>{"country":"us","postalcode":"95123","elevation":"1200"}</pre>

</div>
<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>
<p>Back to <a href="/docs/enterprise/content/developer_guide">API Proxy Developer Guide</a>.</p>


