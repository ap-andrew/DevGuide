<p>[toc]</p>
<p>This quick start demonstrates how to write and deploy JavaScript on the Apigee API Platform using the simple proxy in the&nbsp;<a href="https://github.com/apigee/api-platform-samples">API Platform Samples</a>,&nbsp;available on Github.</p>
<p>One choice that Apigee provides API developers is whether to solve a particular problem using out-of-the-box policies or using custom JavaScript.&nbsp;You will usually find it most convenient to work with a combination of policies and JavaScript applications. For example, you can use Apigee policies to solve generic problems of rate-limiting, mediation, response caching, security and so on. But some problems that you need to solve require custom logic to be executed as part of an API processing flow.</p>
<p>This Quick Start provides three examples that illustrate simple JavaScripts that can be executed on the Apigee platform to customize the behavior of your API.&nbsp;If you have been following the Apigee Platform&nbsp;<a href="/docs/api/quick-starts-index">quick starts</a>, it's a good idea to clean up the Simple Proxy by deleting all policies under&nbsp;<code>apiproxy/policies</code>, and to delete any flows defined in your proxy endpoint configuration file&nbsp;<code>apiproxy/proxies/default.xml</code></p>
<h2>Step 1: Create a JavaScript resource</h2>
<p>In this example, you create a simple JavaScript app that changes the response message by modifying the headers and content of the response generated by the backend service. This JavaScript uses [node:243] that Apigee makes available as part of the flow. The variables used here are response message variables: <code>response.status</code>, <code>response.headers</code>, and <code>response.content</code>.</p>
<p>JavaScript is included as a 'resource' that can be referenced by a policy in an API proxy flow.</p>
<p>First, you need to make sure that there is a directory called <code>resources</code> in the API proxy.</p>
<div id="well">
	<pre>$ cd apiproxy
$ ls
policies	proxies		targets		weatherapi.xml</pre>
</div>
<p>If your API does not have a resources directory, you can create it:</p>
<div id="well">
	<pre>$ mkdir resources</pre>
</div>
<p>Under <code>/resources</code>, create a directory for your JavaScripts called <code>/jsc</code></p>
<div id="well">
	<pre>$ cd resources</pre>
</div>
<div id="well">
	<pre>$ mkdir jsc</pre>
</div>
<p>Next you create the JavaScript, which is a text file containing JavaScript written to the [node:3976].</p>
<h4>Create the JavaScript resource</h4>
<p>In the directory <code>apiproxy/resources/jsc</code> create a file called <code>changeResponse_js</code> with the following contents:</p>
<div id="well">
	<pre>response.status ="200";
response.headers['X-Apigee-Test-Header-1'][0]='Test-Header 1 Value 0';
response.headers['X-Apigee-Test-Header-2'][0]='Test-Header 2 Value 0';
response.headers['X-Apigee-Test-Header-2'][1]='Test-Header 2 Value 1';
response.content='This is your code on Apigee!';</pre>
</div>
<h2>Step 2: Create a JavaScript policy</h2>
<p>To execute a JavaScript resource, you reference it from a JavaScript policy. You create a JavaScript policy for each JavaScript resource that you want to execute. In this step, you create a policy of type JavaScript that references the JavaScript snippet that you created above: <code>changeResponse_js</code>.</p>
<p>Under&nbsp;<code>apiproxy/policies,</code>&nbsp;create a file called <code>changeResponse.xml</code> with the following content:</p>
<div id="well">
	<pre>&lt;Javascript name='changeResponse' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://changeResponse_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
</div>
<h2>Step 3: Attach the JavaScript policy to the proxy endpoint</h2>
<p>Like other policies in Apigee, this JavaScript policy must be attached to the flow in order to be executed. By attaching the policy, you tell the Apigee platform at what point in the processing pipeline the JavaScript should execute.</p>
<p>In this example, you attach the policy to the response processing step of the proxy post flow--the policy will be enforced on the response message before it is returned to the client app.</p>
<p>Your proxy endpoint configuration, <code>apiproxy/proxies/default.xml</code>, should look as follows:</p>
<div id="well">
	<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PostFlow&gt;
&nbsp; &nbsp; &lt;Response&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Response&gt;
&nbsp; &lt;/PostFlow&gt;
&nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
</div>
<h2>Step 4: Import and deploy the API proxy</h2>
<p>Run the deploy tool in the base directory of the API platform samples distribution, substituting your username and password for myname:mypass, and your Apigee organization for myorg.</p>
<div id="well">
	<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o {myorg} -e test -p / -d simpleProxy</pre>
	<div id="well">
		<pre>Writing simpleProxy/apiproxy/weatherapi.xml to apiproxy/weatherapi.xml
Writing simpleProxy/apiproxy/policies/ChangeResponse.xml to apiproxy/policies/ChangeResponse.xml
Writing simpleProxy/apiproxy/proxies/default.xml to apiproxy/proxies/default.xml
Writing simpleProxy/apiproxy/resources/jsc/changeResponse_js to apiproxy/resources/jsc/changeResponse_js
Writing simpleProxy/apiproxy/targets/default.xml to apiproxy/targets/default.xml
Imported new proxy version 1
Environment: test
&nbsp; Revision: 1 BasePath = /
&nbsp; State: deployed
&nbsp;</pre>
	</div>
	<h2>Step 5: Test the JavaScript</h2>
	<p>Note that we use the flag <code>-v</code> to see the headers that the JavaScript created.</p>
	<div id="well">
		<pre>$ curl&nbsp;-v http://{myorg}-test.apigee.net/weather </pre>
	</div>
	<div id="well">
		<pre>&lt; X-Apigee-Test-Header-1: Test-Header 1 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 1
&lt; Content-Length: 27

This is your code on Apigee!</pre>
	</div>
	<h2>Sample 2: Modify the HTTP response code and return an HTTP 302 redirect</h2>
	<p>In this example, we modify the HTTP response code to redirect the requesting client app to Apigee.</p>
	<h4>Create the JavaScript resource</h4>
	<p>Under <code>apiproxy/resources/jsc</code>, create a file called <code>redirect_js</code> with the following contents:</p>
	<div id="well">
		<pre>request.url = 'request.url = 'http://apigee.com/about/'</pre>
	</div>
	<h4>Create the JavaScript policy</h4>
	<p>Under <code>apiproxy/policies,</code> create a file called redirect.xml ;with the following content:</p>
	<div id="well">
		<pre>&lt;Javascript name='redirect' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://redirect_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
	</div>
	<h4>Attach the JavaScript policy to the proxy request preflow</h4>
	<p>First delete the request preflow configuration from apiproxy/proxies/default.xml</p>
	<p>Note that you do not need to delete the policy or the JavaScript resource--only the references to them that exist in the proxy response postflow.</p>
	<p>The processing pipeline will ignore policies and resources that are not referenced in policy attachments somewhere in the proxy or endpoint flow.</p>
	<div id="well">
		<pre>&lt;PostFlow&gt;
&nbsp; &nbsp; &lt;Response&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Response&gt;
&lt;/PostFlow&gt;</pre>
	</div>
	<p>Then attach the redirect policy to the proxy request preflow. Your proxy endpoint configuration, <code>apiproxy/proxies/default.xml</code>, looks like the following:</p>
	<div id="well">
		<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PreFlow&gt;
&nbsp; &nbsp; &lt;Request&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;redirect&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Request&gt;
&lt;/PreFlow&gt;
&nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
	</div>
	<h4>Step 3: Import and deploy the API proxy</h4>
	<p>Run the deploy tool in the base directory of the API platform samples distribution, substituting your username and password for <code>myname:mypass</code>, and your Apigee organization for <code>myorg</code>.</p>
	<div id="well">
		<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o myorg -e test -p / -d simpleProxy</pre>
	</div>
	<h4>Test the JavaScript</h4>
	<p>Note that you need to add the <code>-v</code> flag to this request to see the HTTP 302 response.</p>
	<div id="well">
		<pre>$ curl http://{myorg}-test.apigee.net/weather -v</pre>
	</div>
	<div id="well">
		<p>The returned message is now Apigee's about.html page.</p>
	</div>
	<h2>Sample 3: Generate a JSON Response</h2>
	<p>In this example, you use JavaScript to generate a static JSON response to a request.</p>
	<h4>Create the JavaScript resource</h4>
	<p>Under apiproxy/resources/jsc, create a file called <code>generateResponse_js</code> with the following contents:</p>
	<div id="well">
		<pre>response.content=''; 
response.headers['Content-Type']='application/json'; 
var json = response.content.asJSON;

json.country = 'us';
json.postalcode = '95123'
json.elevation = 'Very High';</pre>
	</div>
	<h4>Create the policy that references the JavaScript resource</h4>
	<div id="well">
		<p>Under <code>apiproxy/policies</code>, create a file called <code>generateResponse.xml</code> with the following contents:</p>
		<div id="well">
			<pre>&lt;Javascript name='generateResponse' timeLimit='200'&gt;
&nbsp;&nbsp;&nbsp; &lt;ResourceURL&gt;jsc://generateResponse_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
		</div>
		<h4>Attach the JavaScript policy to the proxy endpoint response postflow</h4>
		<p>Attach the redirect policy to the proxy response postflow. (For this policy to be enforced, you do not need to delete the target preflow configuration that you created above, but you will notice in the HTTP headers that the request is still redirected to Apigee, even though a generated response is returned.)&nbsp;</p>
		<p>Your proxy endpoint configuration, <code>apiproxy/proxies/default.xml</code>, looks like the following:</p>
		<div id="well">
			<pre>&lt;ProxyEndpoint name="default"&gt;
  &lt;PostFlow&gt;
    &lt;Response&gt;
      &lt;Step&gt;
&nbsp; &nbsp;     &lt;Name&gt;generateResponse&lt;/Name&gt;
      &lt;/Step&gt;
&nbsp; &nbsp;&lt;/Response&gt;
&lt;/PostFlow&gt;
&nbsp; &nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
		</div>
		<h4>Test the JavaScript</h4>
		<div id="well">
			<pre>$ curl http://{myorg}-test.apigee.net/weather</pre>
		</div>
		<div id="well">
			<pre>{"country":"us","postalcode":"95123","elevation":"1200"}</pre>
		</div>
		<h2>Next Steps</h2>
		<p>You now have an understanding of the basic mechanics working with JavaScript on the API Platform.</p>
		<p>To recap:</p>
		<ol>
			<li>Write your JavaScript</li>
			<li>Create a JavaScript resource under <span style="font-family:courier new,courier,monospace;"><code>/resources/jsc</code></span>&nbsp;in your <code>/apiproxy</code></li>
			<li>Create a matching policy of type 'Javascript' under<span style="font-family:courier new,courier,monospace;"> /policies</span>&nbsp;in your&nbsp;<span style="font-family:courier new,courier,monospace;"><code>/apiproxy</code></span></li>
			<li>Attach the policy at the appropriate point in the processing flow</li>
			<li>Upload, deploy, test and trace API calls in the Apigee UI to debug your JavaScript</li>
		</ol>
		<p>For more advanced JavaScript development on the API Platform, see [node:3975].</p>
		<p>If you run into problems or have questions, post to the <a href="http://support.apigee.com">Developer Forum</a>.</p>
		<p>Also, remember that you can use all of the tools available to you in the <a href="http://enterprise.apigee.com">Apigee UI</a> to help you craft your API facade.</p>
		<p><a href="/docs/api/quick-starts-index">See all Quick starts</a></p>
	</div>
</div>
<p>&nbsp;</p>
