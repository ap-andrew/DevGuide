<p>[toc]</p>
<p>This topic covers examples that illustrate simple JavaScripts that can be executed on the API Platform to customize the behavior of an API.</p>

<p>One choice that Apigee provides API developers is whether to solve a particular problem using out-of-the-box policies or using custom JavaScript. Depending on a developer's background, it is usually most convenient to work with a combination of policies and JavaScript applications. For example, you can use policies to address generic requirements such as rate-limiting, mediation, response caching, security and so on, while implementing custom behavior in JavaScript to solve more interesting problems.</p>

<p>The samples are available in the <a href="https://github.com/apigee/api-platform-samples/tree/master/simpleProxy/apiproxy/resources/jsc">API Platform Samples</a> repository on GitHub.</p>

<h2>Overview</h2>

<p>To execute JavaScript on the API Platform:</p>
<ol>
	<li>Write JavaScript to the [node:3976]</li>
	<li>Create a JavaScript resource under <code>/resources/jsc</code></span>&nbsp;in your <code>/apiproxy</code></li>
	<li>Create a matching policy of type 'Javascript' <code>/apiproxy/policies</code></li>
	<li>Attach the policy at the appropriate point in the processing flow</li>
	<li>Upload, deploy, test and trace API calls in the Management UI to debug your JavaScript</li>
</ol>

<h2>Modifying a response message using JavaScript</h2>

<h3>Creating a JavaScript resource</h3>

<p>This example demonstrates a simple JavaScript app that changes a response message by modifying the HTTP headers and payload of a response generated by the backend service. This JavaScript uses [node:243], which the API Platform makes available as part of the flow processing. The variables used here are response message variables: <code>response.status</code>, <code>response.headers</code>, and <code>response.content</code>.</p>

<p>JavaScript is included as a 'resource' that is in turn referenced by a policy in a ProxyEndpoint or TargetEndpoint flow.</p>

<p>JavaScript is stored in a directory called <code>/resources/jsc</code> under <code>/apiproxy</code>. JavaScript resources are referenced in policies of type <code>Javascript</code> (note, lower case 's'). The JavaScript resource is identified by a pointer in the <code>ResourceURL</code> element. The name must match exactly.</p> 

<p>For example, the following JavaScript can be stored under<code>apiproxy/resources/jsc</code> as a file called <code>changeResponse.js</code>:</p>

<pre>context.proxyResponse.status ="200";
context.proxyResponse.headers['X-Apigee-Test-Header-1'][0]='target.name';
context.proxyResponse.headers['X-Apigee-Test-Header-2'][0]='Test-Header 2 Value 0';
context.proxyResponse.headers['X-Apigee-Test-Header-2'][1]='Test-Header 2 Value 1';
context.proxyResponse.content='This is your code on Apigee!';</pre>

<h3>Creating a JavaScript policy</h3>

<p>JavaScript resources are executed by JavaScript policies. A JavaScript policy references a JavaScript resource by name as <code>ResourceURL</code>. For example, to create a policy that references a JavaScript resources named <code>changeResponse.js</code>, the following policy would be created under<code>/apiproxy/policies</code>:</p>


	<pre>&lt;Javascript name='changeResponse' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://changeResponse.js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>


<p><b>Note: The maximum time limit permitted for JavaScript policies to execute in environments in free trial organization is 200 ms.</b></p>


<h3>Attaching JavaScript policies to a ProxyEndpoint</h3>

<p>Like other policies, JavaScript policies must be attached to a flow in order to be executed. The attachment point for the policy determines the point in the flow where the JavaScript executes. In the following example, the JavaScript policy is attached to the response pipeline of the ProxyEndpoint PostFlow. The policy will be enforced (that is, the JavaScript will execute) on the ProxyEndpoint response message before it is returned to the client app.</p>

<p>The ProxyEndpoint configuration for a JavaScript policy that modifies the ProxyEndpoint response:</p>

<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PostFlow&gt;
&nbsp; &nbsp; &lt;Response&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Response&gt;
&nbsp; &lt;/PostFlow&gt;
&nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>

<h3>Importing and deploying the API proxy</h3>

<p>The deploy tool can be used to deploy the API proxy by substituting valid values for username, password, and organization.</p>

	<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o {org_name} -e test -p / -d simpleProxy</pre>

		<pre>Writing simpleProxy/apiproxy/weatherapi.xml to apiproxy/weatherapi.xml
Writing simpleProxy/apiproxy/policies/ChangeResponse.xml to apiproxy/policies/ChangeResponse.xml
Writing simpleProxy/apiproxy/proxies/default.xml to apiproxy/proxies/default.xml
Writing simpleProxy/apiproxy/resources/jsc/changeResponse.jsc to apiproxy/resources/jsc/changeResponse.jsc
Writing simpleProxy/apiproxy/targets/default.xml to apiproxy/targets/default.xml
Imported new proxy version 1
Environment: test
&nbsp; Revision: 1 BasePath = /
&nbsp; State: deployed
&nbsp;</pre>

<h3>Testing JavaScript</h3>

<p>The curl flag <code>-v</code> can be used to view HTTP headers on the response message modified by the JavaScript.</p>

<pre>$ curl&nbsp;-v http://{org_name}-test.apigee.net/weather </pre>


		<pre>&lt; X-Apigee-Test-Header-1: Test-Header 1 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 1
&lt; Content-Length: 27

This is your code on Apigee!</pre>


<h2>Generating a JSON Response</h2>

<p>The following JavaScript sample generates a static JSON response to a request.</p>

<h3>Creating the JavaScript resource</h3>


<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse.js</code> under <code>/apiproxy/resources/jsc</code> with the following contents:</p>

		<pre>context.proxyResponse.content=''; 
context.proxyResponse.headers['Content-Type']='application/json'; 
var json = context.proxyResponse.content.asJSON;

json.country = 'us';
json.postalcode = '95123'
json.elevation = 'Very High';</pre>

<h3>Creating a policy that references the JavaScript resource</h3>

<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse.xml</code> under <code>apiproxy/policies</code> with the following contents:</p>

			<pre>&lt;Javascript name='generateResponse' timeLimit='200'&gt;
&nbsp;&nbsp;&nbsp; &lt;ResourceURL&gt;jsc://generateResponse.js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>

<h3>Attaching the JavaScript policy to the ProxyEndpoint response PostFlow</h3>

<p>To execute this policy, the ProxyEndpoint, <code>/apiproxy/proxies/default.xml</code>, should be configured as follows:</p>

			<pre>&lt;ProxyEndpoint name="default"&gt;
  &lt;PostFlow&gt;
    &lt;Response&gt;
      &lt;Step&gt;
&nbsp; &nbsp;     &lt;Name&gt;generateResponse&lt;/Name&gt;
      &lt;/Step&gt;
&nbsp; &nbsp;&lt;/Response&gt;
&lt;/PostFlow&gt;
&nbsp; &nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>

<h3>Testing the JavaScript</h3>

<pre>$ curl http://{org_name}-test.apigee.net/weather</pre>

<pre>{"country":"us","postalcode":"95123","elevation":"1200"}</pre>

</div>
<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>
<p>Back to <a href="/docs/enterprise/content/developer_guide">API Platform Developer Guide</a>.</p>


