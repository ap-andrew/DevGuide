<p>[toc]</p>

<p>This topic covers three examples that illustrate simple JavaScripts that can be executed on the API Platform to customize the behavior of an API. One choice that Apigee provides API developers is whether to solve a particular problem using out-of-the-box policies or using custom JavaScript. Depending on a developer's background, it is usually most convenient to work with a combination of policies and JavaScript applications. For example, you can use  policies to address generic requirements such as rate-limiting, mediation, response caching, security and so on, while implementing custom behavior in JavaScript to solve more interesting problems.</p>
<p>To execute JavaScript on the API Platform:</p>
<ol>
	<li>Write JavaScript to the [node:3976]</li>
	<li>Create a JavaScript resource under <span style="font-family:courier new,courier,monospace;"><code>/resources/jsc</code></span>&nbsp;in your <code>/apiproxy</code></li>
	<li>Create a matching policy of type 'Javascript' under<span style="font-family:courier new,courier,monospace;"> /policies</span>&nbsp;in your&nbsp;<span style="font-family:courier new,courier,monospace;"><code>/apiproxy</code></span></li>
	<li>Attach the policy at the appropriate point in the processing flow</li>
	<li>Upload, deploy, test and trace API calls in the Management UI to debug your JavaScript</li>
</ol>
<h2>Creating a JavaScript resource</h2>
<p>This example demonstrates a simple JavaScript app that changes a response message by modifying the HTTP headers and payload of a response generated by the backend service. This JavaScript uses [node:243], which the API Platform makes available as part of the flow processing. The variables used here are response message variables: <code>response.status</code>, <code>response.headers</code>, and <code>response.content</code>.</p>
<p>JavaScript is included as a 'resource' that is in turn referenced by a policy in a ProxyEndpoint or TargetEndpoint flow.</p>
<p>JavaScript is stored in a directory called <code>/resources/jsc</code> under <code>/apiproxy</code>, and referenced in a JavaScript policy using the <code>ResourceURL</code> element.</p>

<p>For example, the following JavaScript can be stored under<code>apiproxy/resources/jsc</code> as a file called <code>changeResponse_js</code>:</p>
<div id="well">
	<pre>response.status ="200";
response.headers['X-Apigee-Test-Header-1'][0]='Test-Header 1 Value 0';
response.headers['X-Apigee-Test-Header-2'][0]='Test-Header 2 Value 0';
response.headers['X-Apigee-Test-Header-2'][1]='Test-Header 2 Value 1';
response.content='This is your code on Apigee!';</pre>
</div>
<h2>Creating a JavaScript policy</h2>
<p>JavaScript resources are executed by JavaScript policies. A JavaScript policy references a JavaScript resource by name as <code>ResourceURL</code>. For example, to create a policy that references a JavaScript resources named <code>changeResponse_js</code>, the following policy would be created under<code>/apiproxy/policies</code>:</p>
<div id="well">
	<pre>&lt;Javascript name='changeResponse' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://changeResponse_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
</div>

<p><b>Note: The maximum time limit permitted for JavaScript policies to execute in environments in free trial organization is 200 ms.</b></p>

<h2>Attaching JavaScript policies to a ProxyEndpoint</h2>
<p>Like other policies, JavaScript policies must be attached to a flow in order to be executed. The attachment point for the policy determines the point in the flow where the JavaScript executes. In the following example, the JavaScript policy is attached to the response pipeline of the ProxyEndpoint postflow. The policy will be enforced (that is, the JavaScript will execute) on the ProxyEndpoint response message before it is returned to the client app.</p>
<p>The ProxyEndpoint configuration for a JavaScript policy that modifies the ProxyEndpoint response:</p>
<div id="well">
	<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PostFlow&gt;
&nbsp; &nbsp; &lt;Response&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Response&gt;
&nbsp; &lt;/PostFlow&gt;
&nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
</div>
<h2>Importing and deploying the API proxy</h2>
<p>The deploy tool can be used to deploy the API proxy by substituting valid values for username, password, and organization.</p>
<div id="well">
	<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o {org_name} -e test -p / -d simpleProxy</pre>
	<div id="well">
		<pre>Writing simpleProxy/apiproxy/weatherapi.xml to apiproxy/weatherapi.xml
Writing simpleProxy/apiproxy/policies/ChangeResponse.xml to apiproxy/policies/ChangeResponse.xml
Writing simpleProxy/apiproxy/proxies/default.xml to apiproxy/proxies/default.xml
Writing simpleProxy/apiproxy/resources/jsc/changeResponse_js to apiproxy/resources/jsc/changeResponse_js
Writing simpleProxy/apiproxy/targets/default.xml to apiproxy/targets/default.xml
Imported new proxy version 1
Environment: test
&nbsp; Revision: 1 BasePath = /
&nbsp; State: deployed
&nbsp;</pre>
	</div>
	<h2>Testing JavaScript</h2>
<p>The curl flag <code>-v</code> can be used to view HTTP headers on the response message modified by the JavaScript.</p>
	<div id="well">
		<pre>$ curl&nbsp;-v http://{org_name}-test.apigee.net/weather </pre>
	</div>
	<div id="well">
		<pre>&lt; X-Apigee-Test-Header-1: Test-Header 1 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 0
&lt; X-Apigee-Test-Header-2: Test-Header 2 Value 1
&lt; Content-Length: 27

This is your code on Apigee!</pre>
	</div>
	<h2>Modifying the HTTP response code and return an HTTP 302 redirect</h2>
	<p>In this example,  the HTTP response code is modified using JavaScript to redirect the requesting client app to Apigee.</p>

<h4>Creating a JavaScript resource</h4>
<p>The sample JavaScript below can be stored under <code>apiproxy/resources/jsc</code>, in a file called <code>redirect_js</code> with the following contents:</p>
	<div id="well">
		<pre>request.url = 'request.url = 'http://apigee.com/about/'</pre>
	</div>

<h4>Creating a JavaScript policy</h4>
<p>In this example, the JavaScript resource is referenced in a file called <code>redirect.xml</code> uner <code>/apiproxy/policies</code> with the following content:</p>
	<div id="well">
		<pre>&lt;Javascript name='redirect' timeLimit='200'&gt;
    &lt;ResourceURL&gt;jsc://redirect_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
	</div>

<h4>Attaching a JavaScript policy to the ProxyEndpoint request preflow</h4>


<div id="well"><pre>&lt;PostFlow&gt;
&nbsp; &nbsp; &lt;Response&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;changeResponse&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Response&gt;
&lt;/PostFlow&gt;</pre>
	</div>

<p>The example below demonstrates the attachment of to the ProxyEndpoint request preflow in <code>/apiproxy/proxies/default.xml</code>:</p>
	<div id="well">
		<pre>&lt;ProxyEndpoint name="default"&gt;
&lt;PreFlow&gt;
&nbsp; &nbsp; &lt;Request&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;redirect&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Request&gt;
&lt;/PreFlow&gt;
&nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
</div>

<h2>Generating a JSON Response</h2>
	<p>The following JavaScript sample generates a static JSON response to a request.</p>

<h4>Creating the JavaScript resource</h4>
	<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse_js</code> under <code>/apiproxy/resources/jsc</code> with the following contents:</p>
	<div id="well">
		<pre>response.content=''; 
response.headers['Content-Type']='application/json'; 
var json = response.content.asJSON;

json.country = 'us';
json.postalcode = '95123'
json.elevation = 'Very High';</pre>
	</div>
	<h4>Creating a policy that references the JavaScript resource</h4>
	<div id="well">
		<p>In this example, the JavaScript resource is referenced in a file called <code>generateResponse.xml</code> under <code>apiproxy/policies</code> with the following contents:</p>
		<div id="well">
			<pre>&lt;Javascript name='generateResponse' timeLimit='200'&gt;
&nbsp;&nbsp;&nbsp; &lt;ResourceURL&gt;jsc://generateResponse_js&lt;/ResourceURL&gt;
&lt;/Javascript&gt;</pre>
		</div>
		<h4>Attaching the JavaScript policy to the ProxyEndpoint response pipeline postflow</h4>
		<p>To execute this policy, the ProxyEndpoint, <code>apiproxy/proxies/default.xml</code>, should be configured as follows:</p>
		<div id="well">
			<pre>&lt;ProxyEndpoint name="default"&gt;
  &lt;PostFlow&gt;
    &lt;Response&gt;
      &lt;Step&gt;
&nbsp; &nbsp;     &lt;Name&gt;generateResponse&lt;/Name&gt;
      &lt;/Step&gt;
&nbsp; &nbsp;&lt;/Response&gt;
&lt;/PostFlow&gt;
&nbsp; &nbsp; &lt;HTTPProxyConnection&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;BasePath&gt;/weather&lt;/BasePath&gt;
&nbsp; &nbsp; &nbsp; &nbsp; &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
&nbsp; &nbsp; &lt;/HTTPProxyConnection&gt;
&nbsp; &lt;RouteRule name="default"&gt;
&nbsp; &nbsp; &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
&nbsp; &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>
		</div>
		<h4>Testing the JavaScript</h4>
		<div id="well">
			<pre>$ curl http://{org_name}-test.apigee.net/weather</pre>
		</div>
		<div id="well">
			<pre>{"country":"us","postalcode":"95123","elevation":"1200"}</pre>
		</div>
	</div>
</div>

<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>

<p>Back to <a href="/docs/api/quick-starts-index">API Platform Developer Guide</a>.</p>
