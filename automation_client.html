<p>To support scripting against the API, you should, for security purposes, create an automation client as the machine user whose credentials are used to invoke the API. The user account for scripts that consume the API should have highly restricted capabilities. You can configure such accounts using the API Platform's role-based access control (RBAC) mechanism.</p>
	
<p>Using RBAC you can, for example, create a role that is only capable of reading reports, but not of creating or modifying reports (or anything else for that matter). You can also create a role that enables a user to deploy API proxies to the test environment, but not to deploy them to the prod environment.</p>

<p>You can enable restrictive RBAC by following these steps:</p>
	
<ol>
<li>Create a user scoped to your organization (sometimes called an "org user")</li>
<li>Define a role with a restrictive set of permissions against a specific resource</li>
<li>Associate the org user from Step 1 with the restrictive role you defined in Step 2</li>
<li>Use the credentials for the org user in programs that consume the Platform API</li></ol>

<p>The API Platform supports two types of users:</p>

<p><b>System-level users:</b> Users created at the base level of the API Platform, who can be associated with more than one organization. (When you set up a free trial account on the API Platform, your account is a 'system-level' account.) Therefore, your account is scoped to:</p>

<pre>api.enterprise.apigee.com/v1/o/{your_email}</pre>

<p>You must have an on-premise deployment of Apigee Enterprise to create, view, or delete system-level users.</p>

<p><b>Organization-level users:</b> Org-level users can only be part of one organization. Apigee single-sign on capabilities between Apigee products do not apply to these accounts. Org-level users also have no login flow or password reset.</p>

<p>Org-level users accounts are scoped to the following URI:</p>

<pre>api.enterprise.apigee.com/v1/o/{org_name}/users/{your_email}</pre>

<p>You should create an org-level user account for your automation client. When you create a user via the Platform API, you create an org-level user by default.</p>

<div class="warning"><p>The user account that you create following these instructions is not a typical user of the Apigee Platform. The credentials cannot be used to log in to the Management UI. Only use this process to create automation clients.</p></div>

<h3>Create an org-level user</h3>

<p>To create an org-level user, submit a request with the following payload:</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d \
'{
  "emailId" : "{email_address}",
  "firstName" : "{first_name}",
  "lastName" : "{last_name}",
   "password" : "{password}"
}' 
https://api.enterprise.apigee.com/v1/o/{org_name}/users \
-u myname:mypass</pre>

<p>For example:</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d '{
  "emailId" : "automation_client@apifactory.com",
  "firstName" : "automation",
  "lastName" : "client",
   "password" : "MySecret1"
}' https://api.enterprise.apigee.com/v1/o/apifactory/users \
-u myname:mypass</pre>

<p>Response:</p>

<pre>{
  "emailId" : "automation_client@apifactory.com",
  "firstName" : "automation",
  "lastName" : "client"
}
</pre>

<p>You now have an organization user with username <code>automation_client@apifactory.com</code> and password <code>MySecret1</code>.</p>

<p>Note that the email address does not need to be an actual, validated email address. The email address for automation clients is merely a unique identifier.</p>

<h3>Create a restrictive role</h3>

<p>In this example, you create a role that has only READ permissions on reports generated by Analytics Services.</p>

<p>A <b>role</b> is a collection of <b>permissions</b> on <b>resources</b>. Each organization has a set of pre-defined roles. You can see a list of pre-defined roles by running the following command:</p>

<pre class="terminal">$ curl https://api.enterprise.apigee.com/v1/o/{org_name}/userroles \
-u myname:mypass</pre>

<p>Response:</p>

<pre>[ "opsadmin", "businessuser", "user", "development", "orgadmin" ]</pre>

<p>You can see the permissions available to users in each role by running the following command:</p>

<pre class="terminal">>$ curl https://api.enterprise.apigee.com/v1/o/{org_name}/userroles/user/permissions \
-u myname:mypass</pre>

<p>Response (truncated):</p>

<pre>{
  "resourcePermission" : [ {
    "organization" : "apifactory",
    "path" : "/",
    "permissions" : [ "get" ]
  }, {
    "organization" : "apifactory",
    "path" : "/applications",
    "permissions" : [ "put", "get", "delete" ]
  } 
  . . . ]
}</pre>

<p>You can see that a role consists of a collection of <i>permissions</i> on <i>resources</i>, known as <code>resourcePermissions</code>. Each <code>resourcePermission</code> is defined by the organization, a resource path (a URI fragment), and one or more permissions. </p>

<p>You can get a list of resources that are defined in your organization by running the following command:</p>

<pre class="terminal">$ curl https://api.enterprise.apigee.com/v1/o/{org_name}/resources \
-u myname:mypass</pre>

<p>Response (truncated):</p>

<pre>{
  "resource" : [ {
    "displayName" : "APIs",
    "path" : "/applications"
  }, {
    "displayName" : "Products",
    "path" : "/apiproducts"
  }, {
    "displayName" : "Developers",
    "path" : "/developers"
  }, {
    "displayName" : "Apps",
    "path" : "/apps"
  }, {
    "displayName" : "Companies",
    "path" : "/companies"
  }, {
    "displayName" : "Environments",
    "path" : "/environments"
  }, {
    "displayName" : "Analytics Data",
    "path" : "/environments/*/stats"
  } 
  . . . ]
}</pre>

<p>Resources are paths (URI fragments) that are defined using pattern matching rules. Path rules support wildcards. You can use wildcards to scope the resource definitions that you create, from the very general to the very specific.
</p>

<p>The following example defines all environments in an organization as a resource:</p>

<pre>/environments</pre>

<p>The following example defines Analytics statistics in any environment:</p>

<pre>/environments/*/stats</pre>

<p>The following example defines Analytics stats in <i>only</i> in the environment named <code>test</code>:</p>

<pre>/environments/test/stats</pre>

<p>The following example defines all resources in the environment named <code>test</code>:</p>

<pre>/environments/test/**</pre>

<p>To restrict access to a specific resource, you must create the resource. For example, to create the environment called test as a specific resource, submit the following API call:</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d '{
  "displayName" : "Test environment",
  "path" : "/environments/test",
  }' \
https://api.enterprise.apigee.com/v1/o/apifactory/resource \
-u myname:mypass</pre>

<p>The goal when creating roles for automation clients is restrict their permissions as much as possible.</p>

<p>To create a more specific resource, such as Analytics statistics for APIs in the test environment:</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d '{
  "displayName" : "Stats for APIs in the test environment",
  "path" : "/environments/test/stats/applications",
  }' \
https://api.enterprise.apigee.com/v1/o/apifactory/resources \
-u myname:mypass</pre>


<p>You associate roles with resources through permissions. Permissions map to HTTP verbs.:
	
	<ul><li>GET: Enables read operations.</li>
	<li>PUT: Combines PUT and POST verbs to enable create and update operations.</li>
	<li>DELETE: Enables delete operations</li></ul>
	
<p>In the following steps, you create a role called report_reader, and you associate report_reader with the GET permission on the /reports resource.</p>

<p>Create a new role called Report Reader:</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d '{
  "role" : [ { 
	"name" : "report_reader"
    } ]
  }' \
https://api.enterprise.apigee.com/v1/o/apifactory/userroles \
-u myname:mypass</pre>

<p>Response:</p>

<pre>{
  "role" : [ {
    "name" : "report_reader"
  } ]
}</pre>

<p>Add resource permissions to the newly created role. Specify the path that you created for the resource that you want to protect, in this case, <p>/environments/test/stats/applications</p>.</p>


<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d '{
  "path" : "/environments/test/stats/applications", 
  "permissions" : [ "get" ] 
}' \
https://api.enterprise.apigee.com/v1/o/apifactory/userroles/report_reader/resourcepermissions \
-u myname:mypass</pre>

<p>Response:</p>

<pre>{
  "path" : "/environments/test/stats/applications",
  "permissions" : [ "get" ]
}</pre>

<p>You now have a role called <code>report_reader </code>that has only the ability to GET (that is, to read) statistics gathered for applications in the test environment.
</p>

<p>Now add the user <code>automation_client@apifactory.com</code> (that we created above) to the <code>report_reader</code> role.</p>

<pre class="terminal">$ curl -H "Content-type:application/json" -X POST -d \
'{
  "role" : [ {
    "name" : "report_reader"
  } ]
}'
https://api.enterprise.apigee.com/v1/o/apifactory/users/automation_client@apifactory.com/userroles \
-u myname:mypass</pre>

<p>Response:</p>

<pre>{
  "role" : [ {
    "name" : "report_reader"
  } ]
}</pre>

<p>You have now created a user in your organization named <code>automation_client@apifactory.com</code> who has one capability--the ability to read statistics for applications in the test environment.</p>

<p>You have now limited the risk associated with stolen credentials.</p>

<p>For example, if the credentials are used to read the list APIs deployed in your organization:</p>

<pre class="terminal">$ curl https://api.enterprise.apigee.com/v1/o/apifactory/apis -u automation_client@apifactory.com:MySecret1 -I</pre>

<p>Response:</p>

<pre>HTTP/1.1 403 Forbidden</pre>

<h2>Get help</h2>

<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>

<h2>Next steps</h2>

<p>[Node:427]</p>

<p>Back to <a href="/docs/enterprise/content/developer_guide">API Proxy Developer Guide</a>.</p>


