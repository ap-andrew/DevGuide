<p>[toc]</p>

<p>This topic demonstrates authoring, storing, and attaching policies in an API proxy.</p>

<h2>Policy creation</h2>

<p>Policies are stored in the <code>/policies</code> directory in an API proxy.</p>

 For documentation of the quota policy itself, please refer to [node:56].

<p>To create a quota policy, which is an XML-formatted configuration file. The quota policy provides settings controlling how often a client application can invoke your API over a given time interval.</p>
<p>In this example, you configure a policy that limits apps to 1 message per minute. While this is not realistic, it does provide a simple way to see the effects of a policy.</p>
<p>First,&nbsp;under&nbsp;<span style="font-family: 'courier new', courier, monospace; ">/policies,&nbsp;</span>create a file called&nbsp;<span style="font-family: 'courier new', courier, monospace; ">QuotaPolicy.xml</span></p>
<p><span style="font-family:arial,helvetica,sans-serif;">Then&nbsp;</span>paste into the file the policy body below:</p>
<pre>&lt;Quota enabled="true" continueOnError="false"
async="false" name="QuotaPolicy"&gt;
    &lt;Allow count="1"/&gt;
    &lt;Interval&gt;1&lt;/Interval&gt;
    &lt;TimeUnit&gt;minute&lt;/TimeUnit&gt;
&lt;/Quota&gt;</pre>

<p>All policies have some settings that are specific to the policy type, and some settings that are generic across all policies.</p>

<p>All policies define the following attributes:</p>
<ul>
	<li><code>enabled</code>: Indicates whether the policy is turned "on" or "off". Policies can be enabled/disabled at runtime. A policy that has <code>enabled</code> set to <code>false</code> is not enforced. </li>
	<li><code>continueOnError</code>: Defines whether the pipeline should continue processing the message if the policy fails. When enforcing quota policies, errors likely indicate that the quota has been exceeded, and, therefore, this attribute should be set to false.</li>
	<li><code>async</code>: If set to <code>true</code> the processing pipeline will continue processing subsequent policy steps before the current step completes. Asynchronous setting is useful when doing callouts to external services as part of a flow.</li>
	<li><code>name</code>: The name that you give to this policy. This name is unique to this policy instance, and it is used to attach the policy to the flow as a processing step.</li>
</ul>
<p>The elements <code>Allow</code>, <code>Interval</code>, and <code>TimeUnit</code> are specific to the quota policy. These elements provide settings that the API Platform enforces on behalf of an API.</p>

<h2><a class="jumplink" name="attach_policy"></a>Policy attachment</h2>
<p>Policies in the <code>/policies</code> directory are available to be executed in the processing pipeline of an API proxy. Policies are executed as processing steps in a flow. To specify where a policy executes, it is attached to a ProxyEndpoint or TargetEndpoint flow as a processing step.</p>

The format of a policy attachment is:

<pre>&lt;Step&gt;
    &lt;Name&gt;{policy_name}&lt;/Name&gt;
&lt;/Step&gt;</pre>

For example:

<pre>&lt;Step&gt;
    &lt;Name&gt;QuotaPolicy&lt;/Name&gt;
&lt;/Step&gt;</pre>

<p>A policy is attached to a flow by adding the step configuration to the appropriate request or response flow in a ProxyEndpoint or TargetEndpoint. For example, a quota must be enforced before any additional processing occurs. Therefore, a quota policy should be attached to the ProxyEndpoint request preflow.</p>
	
<p>For example, the following is a basic ProxyEndpoint configuration (without policy attachments):</p>

<pre>&lt;ProxyEndpoint name="default"&gt;
    &lt;HTTPProxyConnection&gt;
        &lt;BasePath&gt;/weather&lt;/BasePath&gt;
        &lt;VirtualHost&gt;default&lt;/VirtualHost&gt;
    &lt;/HTTPProxyConnection&gt;
  &lt;RouteRule name="default"&gt;
     &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt;
  &lt;/RouteRule&gt;
&lt;/ProxyEndpoint&gt;</pre>

<p>A quota policy can be attached as a processing step to the ProxyEndpoint request preflow as follows:</p>
<pre>&lt;ProxyEndpoint name="default"&gt;
&nbsp; &lt;PreFlow&gt;
&nbsp; &nbsp; &lt;Request&gt;
&nbsp; &nbsp; &nbsp; &lt;Step&gt;&lt;Name&gt;QuotaPolicy&lt;/Name&gt;&lt;/Step&gt;
&nbsp; &nbsp; &lt;/Request&gt;
&nbsp; &lt;/PreFlow&gt;
  &lt;HTTPProxyConnection&gt; 
    &lt;BasePath&gt;/weather&lt;/BasePath&gt; 
    &lt;VirtualHost&gt;default&lt;/VirtualHost&gt; 
  &lt;/HTTPProxyConnection&gt; 
  &lt;RouteRule name="default"&gt; 
    &lt;TargetEndpoint&gt;default&lt;/TargetEndpoint&gt; 
  &lt;/RouteRule&gt; 
&lt;/ProxyEndpoint&gt;</pre>

<p>In the ProxyEndpoint configuration above, the quota policy executes when the ProxyEndpoint receives a request from a client app, and before any additional processing takes place.</p>

<h2><a class="jumplink" name="import_deploy"></a>Importing and deploying changes</h2>
<p>Whenever an API proxy is modified, the changes must be imported to an organization on the API platform and then deployed into an environment.</p>
	In this example, you use the deploy tool to deploy the API proxy to the test environment in our organization.</p>

<p>From the base directory of <span style="font-family:courier new,courier,monospace;">api-platform-samples</span>, run the Python deploy tool, substituting your username and password for <span style="font-family:courier new,courier,monospace;">myname:mypass</span> and your Apigee organization for <span style="font-family:courier new,courier,monospace;">myorg</span>.</p>
<pre>$ python tools/deploy.py -n weatherapi -u myname:mypass -o myorg -e test -p / -d simpleProxy</pre>
<p>You should see the following result:</p>
<pre>Writing ./simpleProxy/apiproxy/weatherapi.xml to apiproxy/weatherapi.xml
Writing ./simpleProxy/apiproxy/policies/QuotaPolicy.xml to apiproxy/policies/QuotaPolicy.xml
Writing ./simpleProxy/apiproxy/proxies/default.xml to apiproxy/proxies/default.xml
Writing ./simpleProxy/apiproxy/targets/default.xml to apiproxy/targets/default.xml
Imported new proxy version 2
Undeploying revision 1 in same environment and path:
Environment: test
  Revision: 2 BasePath = /
  State: deployed</pre>
<div>Note that the deploy tool deploys a new revision of the API proxy, while undeploying the previous revision. If necessary, the revision mechanism can be used to revert to the previous revision of the API proxy, thus rolling back any changes..</div>
<h2><a class="jumplink" name="verify_quota_policy"></a>Verifying policy enforcement</h2>


<p>Submit multiple request to the API, exceeding the quota limit that you set in the quota policy.</p>
<pre>http://{org_name}-test.apigee.net/weather/forecastrss?w=12797282</pre>
<p>After you submit more than 1 request within a minute:</p>
<pre>{"fault":{"faultstring":"policies.ratelimit.QuotaViolation","detail":{"errorcode":"policies.ratelimit.QuotaViolation"}}}</pre>
<p>Now that you understand how to create and attach a simple quota policy, you can begin working locally with all of the policies that are provided by Apigee.</p>
<h2>Configuring conditional policy enforcement</h2>
<p>A powerful feature of the API Platform is conditional policy enforcement.</p>
<p>Conditional statements can be added directly to policy step configurations. For example, to add a conditional statement that enforces a quota policy only for XML messages:</p>
<pre>&lt;Step&gt;
    </span><span>&lt;Condition&gt;request.header.content-type = "text/xml"&lt;/Condition&gt;</span>
    &lt;Name&gt;QuotaPolicy&lt;/Name&gt;
&lt;/Step&gt;</pre>
<p>Conditions have two components, a <i>variable</i> and a <i>conditional operator</i>.</p>
<p>The configuration above uses a variable defined by Apigee: <code>request.header.content-type</code></p>.
<p>It evaluates the <span style="font-family:courier new,courier,monospace;">content-type</span> header in the request message from the client, and checks to see whether that value equals <code>text/xml</span>. If the condition evaluates to true, the policy is enforced.</p>
<p>For more, refer to the the list of [node:243] and [node:231].</p>

<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>

<p>Back to <a href="/docs/api/quick-starts-index">API Platform Developer Guide</a>.</p>
