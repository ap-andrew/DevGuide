<p>[toc]</p>

<p>You have now created, deployed and invoked a basic API proxy. In this topic you will explore the RESTful APIs that are exposed by the API Platform to enable API proxy management. These APIs are useful for exploring, debugging, and scripting the API proxy development lifecycle.</p>

<p>Every organization has a unique software development lifecycle (SDLC). It can be important to synchronize API proxy deployment with the deployment of backend services. </p>
	
<p>The API demonstrated in this topic can be used to integrate API proxy management into your organization's SDLC. A common usage of this API is to write scripts or code that deploys new API proxies, or that migrate API proxies from test into prod, as part of a larger automated process that also deploys or migrates other applications.</p>

<p>The API makes no assumptions about your SDLC (or anyone else's, for that matter). Rather, it exposes atomic functions that can be coordinated by your development team to automate and optimize your API lifecycle.</p>

<p>All of the API Platform APIs are documented in [node:4972].</p>

<h2>Interacting with the API</h2>

<h3>List APIs in your organization</h3>

<p>You can begin by listing all of the API proxies in your organization.</p>

<pre>$ curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/apis</pre>

<p>Sample Response:</p>
<pre>[ "weatherapi" ]</pre>

<h3>Get an API</h3>

<p>You can call the GET method on an API. This call returns a list of all available revisions of the API proxy.</p>
	
<pre>$ curl -u myname:mypass -H "Accept: application/json" https://api.enterprise.apigee.com/v1/o/{org_name}/apis/weatherapi</pre>
	
<p>Sample Response:</p>

<pre>{
  "name" : "weatherapi",
  "revision" : [ "1" ]
}</pre>

<p>The only detail we get is the name of the API along with a 'revision', which in turn has a number. </p>

<p>There is only one revision because you just created this API. As an API moves through the lifecycle of iterative configuration and deployment, the version number increments by integers.</p>

<h3>Get API Revision</h3>

<p><span class="label label-info">Note</span> Don't confuse the <i>version</i> of an API with the <i>revision</i> of an API proxy. The two numbers are unrelated, and the revision number of an API proxy is totally opaque to apps that consume your API.</p> 
	
<p>The API version (for example, <code>api.company.com/v1</code>) should change very infrequently. When you do increment the API version, it signifies to developers that there has been a significant change in the signature of the API. </p>

<p>The API proxy revision is merely an incremented number associated with an API proxy configuration. The API Platform maintains revisions of your configurations so that you can revert a configuration when something goes wrong. By default, an API proxy's revision is automatically incremented every time you deploy an API proxy. This behavior can be overridden in the Management UI and in the API.</p>

<p>See <a href="http://apigee.com/docs/enterprise/content/add-apis#-a-class-jumplink-name-set-root-id-set-root-a-a-class-jumplink-name-api-versions-id-api-versions-a-api-versions">Versioning an API</a> for guidance and instruction on incrementing the interface version of the API that you expose to external developers.</p>

<p>To obtain the detailed profile of an API configuration, you view a specific revision number.</p>

<p>For example, you can call the GET method on  API proxy revision 1 to get a detailed view.</p>

<pre>$ curl -u myname:mypass -H "Accept:application/json" https://api.enterprise.apigee.com/v1/o/{org_name}/apis/weatherapi/revisions/1</pre>
<p><b>Sample Response</b></p>
<pre>{
  "configurationVersion" : {
    "majorVersion" : 4,
    "minorVersion" : 0
  },
  "contextInfo" : "Revision 1 of application weatherapi, in organization {org_name}",
  "createdAt" : 1343178905169,
  "createdBy" : "andrew@apigee.com",
  "lastModifiedAt" : 1343178905169,
  "lastModifiedBy" : "andrew@apigee.com",
  "name" : "weatherapi",
  "policies" : [ ],
  "proxyEndpoints" : [ ],
  "resources" : [ ],
  "revision" : "1",
  "targetEndpoints" : [ ],
  "targetServers" : [ ],
  "type" : "Application"
}</pre>

<p>You can see here that all of the important pieces of the API are empty. There are no policies, no Endpoints, no resources. You will add these to your API in the next Developer Guide topics. You can also read about these configuration elements in the [node:8407].</p>

<h3>Deploying an API to an environment</h3>

<p>Now that your API proxy is configured to receive and forward requests properly, you can deploy it to one or more environments. Usually, you iterate on API proxies in 'test' and then, when ready, you deploy an API proxy to 'prod'. You then publish the 'prod' URL to external developers.</p>
	
<p><b>Note:</b> An API proxy cannot be invoked until is has been deployed.</p>
<p>You deploy the API <b>revision</b> to an environment. First, check environments in your organization.</p>

<h3>How to List Environments</h3>

<p>Every organization on the API Platform has at least two environments: 'test' and 'prod'. The distinction is arbitrary. The goal is to provide you with an area to verify that your API proxy is working properly before you open it up to outside developers. Each environment is really just a network address, enabling you segregate traffic between the API proxies that you are working on, and those that are being accessed by apps at runtime.</p>

<h3>View environments in an organization</h3>

<pre>$ curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/environments</pre>
<p>Sample Response</p>

<pre>[ "test", "prod" ]</pre>

<h3>Deploy your API to the Test Environment</h3>

<p>Now, deploy the API to the test environment</p>

<pre>$ curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/apis/weatherapi/revisions/1/deployments?action=deploy&env=test&basepath=/</pre>

<p>Sample Response</p>

<pre>{
  "aPIProxy" : "weatherapi",
  "environment" : [ test ],
  "name" : "1",
  "organization" : "{org_name}"
}</pre>


<h3>Explore Deployments</h3>

<p>A "deployment" is a deployed revision of your API proxy. An API proxy that is in the deployed state is accessible over the network. It is often useful to check to see in which environment (and if!) your API is deployed. </p>

<p>For example, you might find requests to your API proxy are failing. One troubleshooting step is to ensure that the API proxy is deployed as expected.</p>

<h3>See All Deployments of an API Revision</h3>
<div id="well"><pre>curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/apis/weatherapi/revision/1/deployments</pre></div>

<pre>{
  "aPIProxy" : "weatherapi",
  "environment" : [ {
    "configuration" : {
      "basePath" : "",
      "steps" : [ ]
    },
    "name" : "test",
    "server" : [ {
      "status" : "deployed",
      "type" : [ "message-processor" ],
      "uUID" : "90096dd1-1019-406b-9f42-fbb80cd01200"
    }, {
      "status" : "deployed",
      "type" : [ "message-processor" ],
      "uUID" : "7d6e2eb1-581a-4db0-8045-20d9c3306549"
    }, {
      "status" : "deployed",
      "type" : [ "router" ],
      "uUID" : "1619e2d7-c822-45e0-9f97-63882fb6a805"
    }, {
      "status" : "deployed",
      "type" : [ "router" ],
      "uUID" : "8a5f3d5f-46f8-4e99-b4cc-955875c8a8c8"
    } ],
    "state" : "deployed"
  } ],
  "name" : "1",
  "organization" : "org_name"
}</pre>

<h3>See All Deployments in the Test Environment</h3>
<pre>$ curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/deployments</pre>

<p>Returns the same result as above for every API deployed in the test environment
</p>

<h3>See All Deployments in your organization</h3>
<pre>$ curl -u myname:mypass https://api.enterprise.apigee.com/v1/o/{org_name}/deployments</pre>
<p>Returns the same result as above for all API proxies deployed in all environments.
</p>

<p>Since the API is RESTful, you can simply use the POST method, along with a JSON or XML payload, against the same resource to create an API proxy.</p>

<p>A profile for your API proxy is generated on the API Platform. The default representation of an API proxy is JavaScript object notation (JSON). Below is the default JSON response to the POST request above, which created an API proxy called 'weatherapi'. A description of each element in the profile follows:</p>

	<pre>{
  "configurationVersion" : {
    "majorVersion" : 4,
    "minorVersion" : 0
  },
  "contextInfo" : "Revision 1 of application weatherapi, in organization {org_name}",
  "createdAt" : 1357172145444,
  "createdBy" : "you@yourcompany.com",
  "displayName" : "weatherapi",
  "lastModifiedAt" : 1357172145444,
  "lastModifiedBy" : "you@yourcompany.com",
  "name" : "weatherapi",
  "policies" : [ ],
  "proxyEndpoints" : [ ],
  "resources" : [ ],
  "revision" : "1",
  "targetEndpoints" : [ ],
  "targetServers" : [ ],
  "type" : "Application"
}</pre>
	
<p><span class="label label-info">Note</span> Keep in mind that the response payload merely contains a representation of an API resource--you can create an API proxy using JSON or XML, and you can also retrieve representations of the API proxy as XML or JSON, depending on your needs.</p>

<p>The API proxy profile that is generated demonstrates the complete structure of an API proxy:</p>
<ul>
	<li><code>APIProxy revision</code>: The sequentially numbered iteration of the API proxy configuration, as maintained by the API Platform</li>
	<li><code>APIProxy name</code>: The unique name of the API proxy</li>
	<li><code>ConfigurationVersion</code>: API Platform version to which the API proxy configuration conforms</li>
	<li><code>CreatedAt</code>: Time when the API proxy was generated on the API platform, formatted in UNIX time</li>
	<li><code>CreatedBy</code>: Email address of the Apigee user who created the API proxy</li>
	<li><code>DisplayName</code>: A user-friendly name for the API proxy</li>
	<li><code>LastModifiedAt</code>: Time when the API proxy was generated on the API platform, formatted in UNIX time</li>
	<li><code>LastModifiedBy</code>: Email address of the Apigee user who created the API proxy on the API platform</li>
	<li><code>Policies</code>: A list of policies that have been added to this API proxy</li>
	<li><code>ProxyEndpoints</code>: A list of named ProxyEndpoints</li>
	<li><code>Resources</code>: A list of resources (JavaScript, Python, Java, XSLT) available to be executed in this API proxy</li>
	<li><code>TargetServers</code>: A list of named TargetServers (that can be created using the APi Platform API), used in advanced configurations for load balancing purposes</li>
	<li><code>TargetEndpoints</code>: A list of named TargetEndpoints</li>
</ul>

<p>Note that many of the elements of the API proxy configuration created using the simple POST method above are empty. In the following Developer Guide topics, you will learn how to add and configure the key components of an API proxy.</p>

<p>You can also read about these configuration elements in the [node:8407].</p>

<h2>Scripting against the API</h2>

<p>The [node:4561], available on GitHub provide shell scripts that wrap the Apigee deploy tool. If for some reason you cannot use the Python deploy tool, then you can call the API directly. Both approaches are demonstrated in the sample scripts below.</p>

<h3>Wrapping the Deploy Tool</h3>

<p>First, make sure the <a href="https://github.com/apigee/api-platform-samples/tree/master/tools">Python deploy tool</a> is available in your local environment. </p>
	
<p>Then create a file to hold your credentials. The deployment scripts that you write will import these settings, helping you to centrally manage the credentials for your account. In the API Platform sample, this file is called <a href="https://github.com/apigee/api-platform-samples/tree/master/setup"><code>setenv.sh</code></a>.</p>

<pre>#!/bin/bash

org="Your ORG on enterprise.apigee.com"
username="Your USERNAME on enterprise.apigee.com"

# While testing, it's not necessary to change the setting below
env="test"
# Change the value below only if you have an on-premise deployment
url="https://api.enterprise.apigee.com"
# Change the value below only if you have a custom domain
api_domain="apigee.net"

export org=$org
export username=$username
export env=$env
export url=$url
export api_domain=$api_domain</pre>

<p>The file above makes all of your settings available to the shell script that wrap the deploy tool.</p>

<p>Now create a shell script that imports those settings and uses them to call the deploy tool. (You can see an example <a href="https://github.com/apigee/api-platform-samples/tree/master/setup">here</a>.)
</p>
<pre>#!/bin/bash

source path/to/setenv.sh

echo "Enter your password for the Apigee Enterprise organization $org, followed by [ENTER]:"

read -s password

echo Deploying $proxy to $env on $url using $username and $org

path/to/deploy.py -n {api_name} -u $username:$password -o $org -h $url -e $env -p / -d path/to/apiproxy</pre>

<p>To make your life really easy, also create a script to invoke and test the API, as follows:</p>

<pre>#!/bin/bash

echo Using org and environment configured in /setup/setenv.sh

source /path/to/setenv.sh

set -x

curl "http://$org-$env.apigee.net/{api_basepath}"</pre>

<h3>Directly invoking the API</h3>

<p>It can be useful to write simple shell scripts that automate the process of uploading and deploying API proxies.</p>

<p>The script below directly invokes the Platform API. It undeploys the existing revision of the API proxy that you are updating, creates a ZIP file from the <code>/apiproxy</code> directory containing your proxy configuration files, and then uploads, imports, and deploys the configuration.</p>

<pre>#!/bin/bash

#This sets the name of the API proxy and the basepath where the API will be available
api=api
	
source /path/to/setenv.sh

echo Delete the DS_store file on OSX

echo find . -name .DS_Store -print0 | xargs -0 rm -rf
find . -name .DS_Store -print0 | xargs -0 rm -rf

echo "Enter your password for the Apigee Enterprise organization $org, followed by [ENTER]:"

read -s password

echo Undeploy and delete the previous revision

curl -k -u $username:$password "$url/v1/o/$org/apis/$api/revisions/1/deployments?action=undeploy&env=$env" -X POST -H "Content-Type: application/octet-stream"

curl -k -u $username:$password -X DELETE "$url/v1/o/$org/apis/$api/revisions/1"

rm -rf $api.zip

echo Create the API proxy bundle and deploy

zip -r $api.zip apiproxy

echo Import the new revision to $env environment 

curl -k -v -u $username:$password "$url/v1/o/$org/apis?action=import&name=$api" -T $api.zip -H "Content-Type: application/octet-stream" -X POST

echo Deploy the new revision to $env environment 

curl -k -u $username:$password "$url/v1/o/$org/apis/$apirevisions/1/deployments?action=deploy&env=$env" -X POST -H "Content-Type: application/octet-stream"</pre>

<h2>Get help</h2>

<p>Post questions to the <a href="http://support.apigee.com">Apigee Developer Forum</a>.</p>

<h2>Next steps</h2>

[Node:427]



<p>Back to <a href="/docs/enterprise/content/developer_guide">API Platform Developer Guide</a>.</p>